\chapter{Proponowane rozwi±zanie}
\label{cha:rozwiazanie}

W rozdziale tym przedstawiono informacje .

%---------------------------------------------------------------------------

\section{Model narciarza i ¶rodowiska}
\label{sec:model}

W zaproponowanym rozwi±zaniu trzeba by³a podj±æ pewne decyzje odno¶nie reprezentacji ¶rodowiska oraz narciarza.
Zosta³o przyjête, ¿e stok traktowany jest jako p³aszczyzna, która jest nachylona pod okre¶lonym przez sta³± $\alpha$ k±tem do powierzchni ziemi. Za³o¿enie co do p³askiej powierzchni jest tylko ograniczeniem przyjêtym do testów. Umo¿liwia to ³atwiejsz± analizê wyników niezaburzonych zmianami nachylenia terenu. Jednak stworzony program mo¿e zostaæ zmodyfikowany tak, aby zamodelowaæ bardziej skomplikowan± powierzchniê. 
Narciarz traktowany jest jako punkt materialny o masie m. 
%---------------------------------------------------------------------------

\section{Opis matematyczny modelu}
\label{sec:matematycznyModel}

m - masa\\
g - wspó³czynnik grawitacji\\
$\alpha$ - k±t nachylenia powierzchni stoku do powierzchni ziemi\\

Si³a grawitacji dzia³aj±ca na obiekt o masie m:\\
\begin{equation}
Q = mg
\end{equation}

Si³a ta mo¿e zostaæ roz³o¿ona na dwie si³y sk³adowe wzglêdem powierzchni stoku. Narciarz poruszaj±cy siê w dó³ stoku przypomina klasyczny przyk³ad punktu materialnego staczaj±cego siê po równi pochy³ej.\\
Sk³adowa si³y grawitacji równoleg³a do powierzchni stoku:\\
\begin{equation}
Q_a = mg\sin\alpha
\end{equation}

jest to si³a ¶ci±gaj±ca narciarza w dó³ stoku.

Sk³adowa si³y grawitacji prostopad³a do powierzchni stoku:\\
\begin{equation}
F_n = mg\cos\alpha
\end{equation}

Warto¶æ tej si³y wp³ywa na warto¶æ si³y tarcia dzia³aj±cej na narciarza:\\
\begin{equation}
F_f = \mu F_n = \mu mg\cos\alpha
\end{equation}

Oprócz si³y tarcia uwzglêdniamy równie¿ inn± si³ê oporu jak± jest si³a oporu powietrza. Zale¿y ona od prêdko¶ci poruszania siê obiektu. Prêdko¶æ bêdziemy wyra¿aæ jako pierwsz± pochodn± po³o¿enia - $ \dot{x} $:\\
\begin{equation}
F_{d} = k_{1}\dot{x} + k_{2}\dot{x}^2
\end{equation}

Za³o¿enia, które narzucane s± na sta³e $ k_{1} $ oraz $ k_{2} $:\\
\begin{equation}
\left\{ \begin{array}{ll}
 k_{2} = 0  &\mbox{ $v \le B$} \\ 
 k_{1} = 0 &\mbox{ $v \geq  B$} 
\end{array} \right. 
\end{equation}\\
gdzie $ B $:\\
\begin{equation}
B = 4 \frac{m}{s}
\end{equation}

Ograniczenie to zosta³o zaczerpniête z pracy ???? (Aerodynamic-Drag) i opisane w rozdziale ????

Wspó³czynnik $ k_1 $ ....\\
\begin{equation}
k_1 = ... 
\end{equation}

Wspó³czynnik $ k_2 $ zosta³ opisany w ????\\
\begin{equation}
k_2 = \frac{1}{2} C \rho A
\end{equation}

gdzie:\\
$ C $ - wspó³czynnik oporu\\
$ \rho $ - gêsto¶æ powietrza\\
$ A $ - powierzchnia przednia narciarza prostopad³a do kieruku przep³ywu, a zatem prostopad³a do wektora prêdko¶ci narciarza

%---------------------------------------------------------------------------

\section{Numeryczne rozwi±zanie problemu}
\label{sec:numeryczneRozwiazanie}

Rozpatruj±c wszystkie si³y dzia³aj±ce na narciarza równoleg³e do powierzchni stoku, a wiêc powoduj±ce jego ruch w dó³, otrzymujemy nastêpuj±ce równanie:

\begin{equation}
ma=mgsin\alpha-\mu mgcos\alpha-k_{1}\dot{x} - k_{2}\dot{x}^{2}
\end{equation}

Wyra¼my teraz przyspieszenie jako drug± pochodn± po³o¿enia:

\begin{equation}
a = \ddot{x} 
\end{equation}

Podstawiaj±c do równania:

\begin{equation}
m\ddot{x}=mgsin\alpha-\mu mgcos\alpha-k_{1}\dot{x} - k_{2}\dot{x}^{2}
\end{equation}

Zatem po podzieleniu przez m:

\begin{equation}
\ddot{x}=gsin\alpha-\mu gcos\alpha-\frac{k_{1}}{m}\dot{x} - \frac{k_{2}}{m}\dot{x}^{2}
\end{equation}

Aby rozwi±zaæ to równanie numerycznie, wprowadzamy now± zmienn± v (odpowiadaj±c± prêdko¶ci):

\begin{equation}
v = \dot{x}
\end{equation}

Otrzymujemy nastêpuj±ce równania:\\
\begin{equation}
\left\{ \begin{array}{ll}
\dot{v} = gsin\alpha-\mu gcos\alpha-\frac{k_{1}}{m}v - \frac{k_{2}}{m}v^{2} \\
v = \dot{x}
\end{array} \right. 
\end{equation}

Pamiêtamy przy tym, ¿e:\\
\begin{equation}
\left\{ \begin{array}{ll}
 k_{2} = 0  &\mbox{ $v \le B$} \\ 
 k_{1} = 0 &\mbox{ $v \geq  B$} 
\end{array} \right. 
\end{equation}

Powy¿szy uk³ad równañ wystarczy wykorzystaæ w dostêpnych w wielu jêzykach funkcjach bibliotecznych do rozwi±zywania równañ ró¿niczkowych zwyczajnych. W naszym przypadku wykorzysta³y¶my funkcjê dopri (Numerical integration of ODE using Dormand-Prince RK method) z biblioteki Numeric Javascript.

\subsection{Rozwi±zanie w 3D}
Powy¿szy uk³ad równañ opisuje poruszanie siê punktu materialnego po równi pochy³ej. Jednak w przypadku narciarza przemieszczaj±cego siê po stoku musimy uwzglêdniæ równie¿ mo¿liwo¶æ poruszania siê w poprzek stoku, a nie tylko w dó³.\\
Za³ó¿my, ¿e narciarz porusza siê tylko po liniach prostych. \\
Rozpatrzmy teraz jak bêdzie wygl±da³ uk³ad si³ dzia³aj±cych na narciarza:\\

% obrazek

Na naszego narciarza dzia³aj± si³y: grawitacji - w kierunku pionowym oraz si³y oporu - w kierunku linii jazdy narciarza. Je¶li rozpatrzymy teraz uk³ad wspó³rzêdnych zorientowany wzglêdem kierunku jazdy, musimy najpierw zrzutowaæ si³ê grawitacji otrzymuj±c si³ê ¶ci±gaj±ca narciarza:

\begin{equation}
g\sin\alpha*sinus
\end{equation}

gdzie sinus to:

%-----------------------SINUS-------------------%

Zatem nasze równanie ruchu bêdzie wygl±da³o nastêpuj±co:

\begin{equation}
\ddot{x} = g\sin\alpha*sinus - (\mu F_n + \frac{k_1}{m}\dot{x} + \frac{k_2}{m}\dot{x}^2 )
\end{equation}

gdzie $F_n$ to si³a nacisku narciarza, która pozostaje taka sama jak w przypadku 2D:

\begin{equation}
F_n = gcos\alpha
\end{equation}

Transformuj±c powy¿sze równanie na uk³ad wspó³rzêdnych zorientowany wzd³u¿ i wszerz stoku otrzymamy nastêpj±ce równania:

% sprawdzic x i y 

\begin{equation}
\left\{ \begin{array}{ll}
\ddot{x_x} = (g*\sin\alpha*sinus - (\mu*F_n + \frac{k_1}{m}\dot{x} + \frac{k_2}{m}\dot{x}^2))*sinus\\
\ddot{x_y} = (g*\sin\alpha*sinus - (\mu*F_n + \frac{k_1}{m}\dot{x} + \frac{k_2}{m}\dot{x}^2))*cosinus
\end{array} \right.
\end{equation}

Po wprowadzeniu jak poprzednio dodatkowych zmiennych, w tym wypadku prêdko¶ci $v_x$ i $v_y$ oraz pamiêtaniu o zale¿no¶ci miêdzy nimi a pochodn± przemieszczenia:

\begin{equation}
\left\{ \begin{array}{ll}
v_x = \dot{x_x}\\
v_y = \dot{x_y}\\
\dot{x} = \sqrt{v_x^2 +v_y^2}
\end{array} \right.
\end{equation}

otrzymujemy:

\begin{equation}
\left\{ \begin{array}{ll}
v_x = \dot{x_x}\\
v_y = \dot{x_y}\\
\dot{v_x} = (g*\sin\alpha*sinus - (\mu*N + \frac{k_1}{m}\dot{x} + \frac{k_2}{m}\dot{x}^2))*sinus\\
\dot{v_y} = (g*\sin\alpha*sinus - (\mu*N + \frac{k_1}{m}\dot{x} + \frac{k_2}{m}\dot{x}^2))*cosinus
\end{array} \right. 
\end{equation}\\


%---------------wzory razem z zakrêtami - gdzie?--------

$$
\left\{\begin{array}{ll} 
  v_x=\dot{x_x} \\
  v_y=\dot{x_y} \\
 \dot{v_x} = gsin\alpha - (\dot{x_x}^2 +\dot{x_y}^2)^{\frac{1}{2}} \kappa \dot{x_y} sgn(\dot{\varphi}) - gsin\alpha \frac{\dot{x_y}^2}{\dot{x_x}^2 +\dot{x_y}^2} - \frac{(F_f + F_d) }{m}\frac{\dot{x_x}}{(\dot{x_x}^2 +\dot{x_y}^2)^{\frac{1}{2}}} \\
 \dot{v_y} = (\dot{x_x}^2 +\dot{x_y}^2)^{\frac{1}{2}} \kappa \dot{x_x} sgn(\dot{\varphi}) + gsin\alpha \frac{\dot{x_x}} {\dot{x_x}^2 +\dot{x_y}^2} - \frac{(F_f + F_d)}{m}\frac{\dot{x_y}}{(\dot{x_x}^2 +\dot{x_y}^2)^{\frac{1}{2}}} 
\end{array}\right.
$$\\
%---------------------------------------------------------------------------

\section{Optymalizacja toru przejazdu}
\label{sec:optymalizacja}
Aby znale¼æ rozwi±zanie problemu, nale¿y przyj±æ jaki¶ sposób reprezentacji ka¿dego z rozwi±zañ. Tor przejazdu narciarza w rzeczywisto¶ci to ¶lad, który pozostawiaj± narty na ¶niegu w trakcie przemieszczania siê po stoku. Jak opisano w rozdziale \ref{sec:matematycznyModel} ????, w celu uproszczenia sposobu przemieszczania siê narciarza, zosta³o zdecydowane, ¿e jako przybli¿enie mo¿na przyj±æ poruszanie siê po ³amanej. Zatem do reprezentacji rozwi±zania mo¿na przyj±æ zbiór punktów, przez które kolejno przeje¿d¿a narciarz, poruszaj±c siê miêdzy tymi punktami wy³±cznie po linii prostej.\\
Jednak wci±¿ takie podej¶cie jest niewystarczaj±ce, poniewa¿ w algorytmach optymalizacyjnych potrzebujemy ¶ci¶lejszego opisu, aby wiedzieæ jak skutecznie przeszukiwaæ przestrzeñ rozwi±zañ. Zatem w zaproponowonym rozwi±zaniu narzucamy z góry co ile metrów w pionie stoku ma pojawiæ siê punkt. Mo¿na traktowaæ to jako poziome linie, z której ka¿da wyznacza mo¿liwe po³o¿enie pojedynczego punktu. Oprócz tego narzucone zosta³o, ¿e narciarz musi przejechaæ jak najbli¿ej ka¿dej wewnêtrznej bramki, co indukuje do³o¿enie punktów w miejscu ka¿dej wewnêtrznej bramki. Warunek ten jest spowodowany tym, ¿e w przeciwnym przypadku algorytm mia³by do przeszukania du¿o wiêcej rozwi±zañ. Opieraj±c siê na do¶wiadczeniu z rzeczywistych slalomów, wiadomo, ¿e przeje¿d¿anie tu¿ przy bramkach jest najkorzystniejsze.
%chyba ¿e do³o¿ymy tê mo¿liwo¶æ, ¿e niektóre mog± byæ albo s± automatycznie wychwytywane. albo ¿e testowane by³o te¿ to jak siê zachowuje je¶li odrzucimy to ograniczenie.

Zatem pozostaje okre¶liæ w jaki sposób mo¿emy stwierdziæ, ¿e dane rozwi±zanie jest najlepsze. W przypadku algorytmów optymalizacyjnych zawsze nale¿y okre¶liæ funkcjê celu. W naszym przypadku interesuje nas, aby narciarz w jak najkrótszym czasie dotar³ do mety. Maj±c dane rozwi±zanie w postaci punktów wyznaczaj±cych ³aman±, obliczamy ile czasu zajmie narciarzowi przejechanie po tej trasie. Im mniejsza warto¶æ tym rozwi±zanie jest lepsze, gdy¿ tym mniej czasu potrzebuje narciarz na prawid³owe pokonanie slalomu.

\subsection{Algorytm ewolucyjny}
Opisana powy¿ej reprezentacja rozwi±zania to w zastosowanym algorytmie ewolucyjnym pojedynczy osobnik, a punkty sk³adaj±ce siê na to rozwi±zanie, a ¶ci¶lej, ich po³o¿enie w pozycji poziomej okre¶laj± genotyp ka¿dego osobnika. Nie wprowadzamy tu typowego dla algorytmów genetycznych kodowania binarnego, pozycja ka¿dego punktu jest zapamiêtana jako warto¶æ rzeczywista.\\
Dodatkowo do genotypu wchodzi tak¿e parametr $\sigma$, który w strategiach ewolucyjnych u¿ywany jest podczas mutacji tak jak opisano w rozdziale \ref{cha:wstepTeoretyczny} w czê¶ci o strategiach. Ka¿demu punktowi przypisana jest osobna warto¶æ $\sigma$ - odchylenie standardowe.

Zastosowany algorytm opiera siê na strategii ($\mu$ + $\lambda$) opisanej w rozdziale \ref{cha:wstepTeoretyczny}. Jako pocz±tkow± populacjê wybieramy losowe osobniki - poziome warto¶ci punktów s± ograniczone jedynie przez warto¶ci poziome po³o¿enia dwóch najbli¿szych bramek. Jest to kierowane konieczno¶ci± zadbania o szybsze znalezienie rozwi±zania - zbyt du¿e odleg³o¶ci mo¿na z góry odrzuciæ opieraj±c siê na do¶wiadczeniach z rzeczywistej jazdy narciarza po slalomie. Wielko¶æ populacji bazowej $\mu$ jest jednym z parametrów programu, ale najczê¶ciej warto¶æ ta wynosi 30. Warto¶æ parametru $\lambda$ tak¿e jest parametrem, jednak w testach przewa¿nie u¿yto wielko¶ci 100.\\
Szkielet algorytmu zgodny jest z zastosowan± strategi±, po wylosowaniu z istniej±cej populacji populacji tymczasowej o wielko¶ci $\lambda$, dokonuje siê na jej osobnikach operacji genetycznych, najpierw krzy¿owania, a nastêpnie mutacji na osobnikach otrzymanych z krzy¿owania. Kolejnym krokiem jest ocenienie nowych osobników i wybranie spo¶ród nich oraz populacji pocz±tkowej osobników o najlepszym przystosowaniu i to one stanowi± now± populacjê bazow±.

\subsubsection{Krzy¿owanie}
Aby dokonaæ krzy¿owania potrzebne s± pary rodziców dla ka¿dego nowego osobnika. Aby utrzymaæ wielko¶æ populacji tymczasowej, losujemy (ze zwracaniem) $\lambda$ par spo¶ród populacji tymczasowej. Krzy¿owanie rodziców sprowadza siê do obliczenia ¶redniej warto¶ci po³o¿enia odpowiadaj±cych sobie punktów oraz parametrów $\sigma$.

\subsubsection{Mutacja}
Po krzy¿owaniu mamy znowu w populacji tymczasowej $\lambda$ osobników. Mutacja osobników przeprowadzana jest zgodnie ze strategi± - wykorzystywane s± warto¶ci odchyleñ standardowych odpowiadaj±cych kolejnym punktom. Jedynie punkty, które s± przy bramkach nie podlegaj± mutacji. Wynika to z wcze¶niejszego za³o¿enia, ¿e wtedy otrzymamy rozwi±zanie najlepsze.

\subsubsection{Warunek zakoñczenia}
Warunek zakoñczenia algorytmu zawsze sprawia wiele problemów. Nie jest ³atwo zdecydowaæ na jakiej podstawie zatrzymywaæ jego dzia³anie. Czêsto korzysta siê z informacji o rozrzucie przystosowania w populacji - obliczamy go na podstawie ró¿nicy pomiêdzy najlepszym i najgorszym osobnikiem. Je¶li rozrzut ten jest niewielki mo¿e oznaczaæ stagnacjê algorytmu. Niekoniecznie ¶wiadczy to o znalezieniu rozwi±zania, ale w po³±czeniu z dodatkowymi mechanizmami mo¿e byæ skuteczn± metod± na decyzjê o zakoñczeniu optymalizacji.\\
W naszym rozwi±zaniu bierzemy zatem równie¿ pod uwagê taki wska¼nik jak poprawa najlepszego obecnego rozwi±zania. Je¶li przez okre¶lon± liczbê iteracji, najczê¶ciej kilka lub kilkana¶cie najlepsze rozwi±zanie nie poprawia siê w ogóle, a populacja jest bardzo ma³o zró¿nicowana to jest to znak, ¿e znalezione rozwi±zanie powinno byæ wystarczaj±co bliskie najlepszemu. Oczywi¶cie steruj±c liczb± iteracji przez które sprawdzamy zmiany oraz wielko¶ci± rozrzutu populacji mo¿emy znajdowaæ lepsze lub gorsze rozwi±zania kosztem wyd³u¿enia lub skrócenia czasu dzia³ania algorytmu.

\subsection{Hill climbing}
Zastosowanie algorytmu genetycznego sprawdzi³o siê w przypadku problemu narciarza, jednak problemem by³ d³ugi czas wykonywania siê programu. Zw³aszcza s³aba poprawa wyników wystêpowa³a w koñcowej fazie dzia³ania. Widoczne by³y niepotrzebne próby przeszukiwania zbyt odleg³ych rozwiazañ, a jednak wci±¿ znalezione rozwi±zanie nie by³o tak dobre jak mo¿na by tego oczekiwaæ. Wiedz±c, ¿e rozwi±zanie jest ju¿ dosyæ bliskie najlepszemu mo¿na z du¿ym prawdopodobieñstwem za³o¿yæ, ¿e wystarczy znale¼æ rozwi±zanie lokalnie optymalne, aby by³o ono satysfakcjonuj±ce. Oczywi¶cie nie mamy pewno¶ci, ¿e bêdzie globalnie optymalne, ale takiej pewno¶ci nie mo¿emy mieæ nigdy.\\
Zatem zastosowanie algorytmu lokalnej optymalizacji powinno pomóc w koñcowej fazie poszukiwañ. Z tego powodu u¿yty zosta³ algorytm Hill climbing opisany w rozdziale \ref{cha:wstepTeoretyczny}. W ka¿dym kroku algorytmu sprawdzane jest czy zmiana pojedynczej zmiennej - w tym wypadku poziomej pozycji punktu przejazdu, daje poprawê wyniku. Je¶li zmiany te nie przynosz± rezultatów, s± mniejsze ni¿ narzucony parametr $\epsilon$ algorytm zatrzymuje swoje dzia³anie. Warto¶æ $\epsilon$ wynosi przewa¿nie 0.00001. W przypadku parametrów typowych dla tego algorytmu postanowiono wybraæ warto¶ci dla przyspieszenia standardowa - 1.2, natomiast dla kroku, mniejsz± ni¿ zwykle, bo wynosz±c± 0.5. Zmiana ta wynika z za³o¿enia, ¿e rozwi±zanie nie powinno potrzebowaæ wiêkszych zmian, aby znale¼æ rozwi±zanie jak najlepsze.
%---------------------------------------------------------------------------

\section{Architektura systemu}
\label{sec:architektura}

%---------------------------------------------------------------------------

